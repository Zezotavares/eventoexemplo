<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Eventos Fortral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div class="max-w-md mx-auto mt-10 bg-white rounded-lg shadow-xl overflow-hidden relative">
        
        <div class="bg-slate-900 p-6 text-center relative">
            <img src="https://www.fortral.com.br/wp-content/uploads/2025/06/logo.png" 
                 alt="Logo Fortral" 
                 class="h-12 mx-auto object-contain mb-2">
            
            <h1 class="text-xl font-bold text-white mt-2" id="tituloPagina">Sistema de Eventos</h1>
            
            <div id="dataEventoDisplay" class="hidden mt-2 bg-slate-800 text-blue-200 py-1 px-3 rounded-full text-xs inline-flex items-center gap-1">
                <i class="ph ph-calendar-blank"></i> <span id="textoDataEvento"></span>
            </div>

            <p class="text-gray-400 text-sm mt-1" id="subtituloPagina">Carregando...</p>
        </div>

        <div class="p-6">
            
            <div id="areaLogin" class="hidden text-center space-y-4">
                <div class="bg-blue-50 p-4 rounded text-blue-900 text-sm mb-4 flex items-center justify-center gap-2">
                    <i class="ph ph-lock-key text-xl"></i> <span>Área restrita.</span>
                </div>
                <div class="relative w-full">
                    <input type="password" id="senhaAdmin" placeholder="Senha de acesso" 
                           class="w-full p-2 pr-10 border border-gray-300 rounded text-center focus:outline-none focus:border-blue-900 transition">
                    <button type="button" onclick="toggleSenha()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-blue-900">
                        <i class="ph ph-eye text-xl" id="iconeOlho"></i>
                    </button>
                </div>
                <button onclick="verificarSenha()" class="w-full bg-slate-900 text-white p-2 rounded hover:bg-slate-800 font-medium">Entrar</button>
            </div>

            <div id="areaCliente" class="hidden">
                <form id="formCadastro" class="space-y-3">
                    <input type="hidden" id="eventoIdInput">
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase">Nome Completo *</label>
                        <input type="text" id="clienteNome" required class="w-full p-2 border border-gray-300 rounded mt-1 focus:border-blue-900">
                    </div>

                    <div class="flex gap-2">
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-700 uppercase">CPF *</label>
                            <input type="text" id="clienteCPF" maxlength="14" onkeyup="mascaraCPF(this)" required 
                                   placeholder="000.000.000-00" class="w-full p-2 border border-gray-300 rounded mt-1">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-700 uppercase">WhatsApp *</label>
                            <input type="tel" id="clienteTelefone" maxlength="15" onkeyup="mascaraTelefone(this)" required 
                                   placeholder="(00) 00000-0000" class="w-full p-2 border border-gray-300 rounded mt-1">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase">E-mail</label>
                        <input type="email" id="clienteEmail" class="w-full p-2 border border-gray-300 rounded mt-1">
                    </div>

                    <div class="pt-2 border-t mt-2">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Acompanhantes</label>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm text-gray-600">Quantas pessoas vão com você?</span>
                            <input type="number" id="clienteQtdAcomp" min="0" value="0" class="w-16 p-1 border rounded text-center" onchange="toggleAreaAcompanhantes()">
                        </div>
                        
                        <div id="areaDadosAcompanhantes" class="hidden">
                            <label class="block text-xs text-gray-500 mb-1">Nome dos acompanhantes (Opcional):</label>
                            <textarea id="clienteDadosAcomp" rows="2" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Ex: Maria da Silva, João Santos..."></textarea>
                        </div>
                    </div>

                    <button type="submit" id="btnSalvar" class="w-full bg-blue-900 text-white p-3 rounded hover:bg-blue-800 font-bold transition flex justify-center items-center gap-2 mt-4">
                        Confirmar Presença
                    </button>
                </form>

                <div id="msgSucesso" class="hidden mt-4 bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="ph ph-check text-3xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-green-800 mb-1">Presença Confirmada!</h2>
                    <p class="text-green-700 text-sm mb-4">Seus dados foram enviados com sucesso.</p>
                    
                    <div class="bg-white p-3 rounded border border-green-100 text-left text-sm shadow-sm">
                        <p class="text-gray-500 text-xs uppercase font-bold">Lembrete do Evento:</p>
                        <p class="font-bold text-gray-800 text-lg" id="sucessoData"></p>
                        <p class="text-gray-600" id="sucessoHora"></p>
                    </div>
                    <p class="text-xs text-gray-400 mt-4">Tire um print desta tela se desejar.</p>
                </div>
            </div>

            <div id="areaAdmin" class="hidden">
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded mb-6 border border-gray-200">
                    <span class="text-sm text-gray-700 flex items-center gap-2"><i class="ph ph-user-circle text-lg"></i> Admin</span>
                    <button onclick="logout()" class="text-xs text-red-600 hover:underline">Sair</button>
                </div>

                <div class="border-b pb-4 mb-4">
                    <h2 class="font-bold text-lg mb-2 text-gray-700">Criar Novo Evento</h2>
                    <div class="space-y-2">
                        <input type="text" id="novoEventoNome" placeholder="Nome do Evento" class="w-full p-2 border rounded">
                        <div class="flex gap-2">
                            <input type="datetime-local" id="novoEventoData" class="flex-1 p-2 border rounded text-gray-600 text-sm">
                            <button onclick="criarEvento()" class="bg-blue-900 text-white px-4 py-2 rounded hover:bg-blue-800 font-bold">Criar</button>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="font-bold text-lg mb-2 text-gray-700">Eventos Ativos</h2>
                    <ul id="listaEventos" class="space-y-2 text-sm max-h-40 overflow-y-auto pr-1">
                        <li class="text-gray-500">Carregando...</li>
                    </ul>
                </div>
                
                <div class="mt-8 pt-4 border-t">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="font-bold text-lg text-gray-700">Inscritos</h2>
                        <button onclick="exportarExcel()" class="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 flex items-center gap-1">
                            <i class="ph ph-file-csv"></i> Excel
                        </button>
                    </div>
                     <div id="listaCadastros" class="text-left text-xs bg-gray-50 p-2 rounded max-h-60 overflow-y-auto border space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const supabaseUrl = 'https://kixlaiwclsgbabtdfmtn.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpeGxhaXdjbHNnYmFidGRmbXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NjA4MzgsImV4cCI6MjA4MzEzNjgzOH0.r9OF9C88prJs4tuBkz6xu_lKjjzixz5UHnVKDbLtx2E';
        const SENHA_ADMIN = 'Fortral@1993';
        
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- ELEMENTOS ---
        const areaLogin = document.getElementById('areaLogin');
        const areaCliente = document.getElementById('areaCliente');
        const areaAdmin = document.getElementById('areaAdmin');
        const titulo = document.getElementById('tituloPagina');
        const subtitulo = document.getElementById('subtituloPagina');
        const dataDisplay = document.getElementById('dataEventoDisplay');

        // --- INICIALIZAÇÃO ---
        const urlParams = new URLSearchParams(window.location.search);
        const eventoIdParam = urlParams.get('evento_id');

        if (eventoIdParam) {
            iniciarModoCliente(eventoIdParam);
        } else {
            mostrarLogin();
        }

        // --- MÁSCARAS ---
        function mascaraTelefone(input) {
            let v = input.value.replace(/\D/g, "");
            v = v.replace(/^(\d\d)(\d)/g, "($1) $2");
            v = v.replace(/(\d{5})(\d)/, "$1-$2");
            input.value = v;
        }

        function mascaraCPF(i) {
            let v = i.value.replace(/\D/g, "");
            i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        }

        function toggleAreaAcompanhantes() {
            const qtd = document.getElementById('clienteQtdAcomp').value;
            const area = document.getElementById('areaDadosAcompanhantes');
            if (qtd > 0) area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        // --- LOGIN ---
        function mostrarLogin() {
            titulo.innerText = "Acesso Restrito";
            subtitulo.innerText = "Identifique-se";
            areaLogin.classList.remove('hidden');
        }
        function verificarSenha() {
            if (document.getElementById('senhaAdmin').value === SENHA_ADMIN) {
                areaLogin.classList.add('hidden');
                iniciarModoAdmin();
            } else alert("Senha incorreta!");
        }
        function toggleSenha() {
            const input = document.getElementById('senhaAdmin');
            input.type = input.type === "password" ? "text" : "password";
        }
        function logout() { location.reload(); }

        // --- CLIENTE ---
        async function iniciarModoCliente(id) {
            const { data, error } = await supabaseClient
                .from('eventos')
                .select('nome, data_evento')
                .eq('id', id)
                .single();

            if (error || !data) {
                titulo.innerText = "Evento Indisponível";
                subtitulo.innerText = "Verifique o link.";
                return;
            }

            areaCliente.classList.remove('hidden');
            titulo.innerText = "Confirme sua Presença";
            subtitulo.innerText = data.nome;
            document.getElementById('eventoIdInput').value = id;

            // Formata e exibe a data do evento
            if (data.data_evento) {
                const dataObj = new Date(data.data_evento);
                const dataFormatada = dataObj.toLocaleDateString('pt-BR') + ' às ' + dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                
                document.getElementById('textoDataEvento').innerText = dataFormatada;
                dataDisplay.classList.remove('hidden');
                
                // Prepara dados para a tela de sucesso
                document.getElementById('sucessoData').innerText = dataObj.toLocaleDateString('pt-BR');
                document.getElementById('sucessoHora').innerText = dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) + "h";
            }
        }

        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSalvar');
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "Enviando...";
            
            const dados = {
                evento_id: document.getElementById('eventoIdInput').value,
                nome: document.getElementById('clienteNome').value,
                cpf: document.getElementById('clienteCPF').value,
                telefone: document.getElementById('clienteTelefone').value,
                email: document.getElementById('clienteEmail').value,
                acompanhantes_qtd: document.getElementById('clienteQtdAcomp').value,
                acompanhantes_info: document.getElementById('clienteDadosAcomp').value
            };

            // Checa duplicidade de CPF ou Telefone neste evento
            const { data: existe } = await supabaseClient
                .from('participantes')
                .select('id')
                .eq('evento_id', dados.evento_id)
                .or(`telefone.eq.${dados.telefone},cpf.eq.${dados.cpf}`)
                .maybeSingle();

            if (existe) {
                alert("Atenção: Já existe um cadastro com este CPF ou Telefone para este evento.");
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
                return;
            }

            const { error } = await supabaseClient.from('participantes').insert([dados]);

            if (error) {
                alert('Erro: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            } else {
                document.getElementById('formCadastro').classList.add('hidden');
                titulo.style.display = 'none';
                subtitulo.style.display = 'none';
                dataDisplay.style.display = 'none';
                document.getElementById('msgSucesso').classList.remove('hidden');
            }
        });

        // --- ADMIN ---
        function iniciarModoAdmin() {
            areaAdmin.classList.remove('hidden');
            titulo.innerText = "Painel Admin";
            subtitulo.innerText = "Gestão de Eventos";
            carregarEventos();
            carregarInscritos();
        }

        async function criarEvento() {
            const nome = document.getElementById('novoEventoNome').value;
            const dataEvento = document.getElementById('novoEventoData').value; // Formato yyyy-mm-ddThh:mm
            
            if (!nome || !dataEvento) return alert("Preencha o nome e a data do evento.");
            
            const { error } = await supabaseClient.from('eventos').insert([{ nome, data_evento: dataEvento }]);
            if (error) alert(error.message);
            else {
                document.getElementById('novoEventoNome').value = "";
                document.getElementById('novoEventoData').value = "";
                carregarEventos();
            }
        }

        async function carregarEventos() {
            const { data } = await supabaseClient.from('eventos').select('*').order('data_criacao', { ascending: false });
            const lista = document.getElementById('listaEventos');
            lista.innerHTML = "";
            
            if(data) {
                data.forEach(ev => {
                    const link = `${window.location.origin}${window.location.pathname}?evento_id=${ev.id}`;
                    // Formatação bonita da data
                    const dataFormatada = ev.data_evento ? new Date(ev.data_evento).toLocaleDateString('pt-BR') : 'Data não def.';
                    
                    lista.innerHTML += `
                        <li class="bg-white p-3 rounded border flex justify-between items-center hover:bg-gray-50">
                            <div>
                                <div class="font-bold text-gray-800">${ev.nome}</div>
                                <div class="text-xs text-gray-500"><i class="ph ph-calendar"></i> ${dataFormatada}</div>
                            </div>
                            <button onclick="copiarLink('${link}')" class="text-xs bg-blue-100 text-blue-900 px-2 py-1 rounded font-bold">Link</button>
                        </li>
                    `;
                });
            }
        }

        async function carregarInscritos() {
            const div = document.getElementById('listaCadastros');
            div.innerHTML = "Carregando...";
            
            const { data } = await supabaseClient
                .from('participantes')
                .select('nome, telefone, cpf, acompanhantes_qtd, acompanhantes_info, eventos(nome)')
                .order('data_cadastro', { ascending: false })
                .limit(50);

            if(data && data.length) {
                div.innerHTML = data.map(p => `
                    <div class="bg-white border p-2 rounded">
                        <div class="flex justify-between font-bold text-gray-800">
                            <span>${p.nome}</span>
                            <span class="text-[10px] bg-gray-200 px-1 rounded h-fit">${p.eventos?.nome}</span>
                        </div>
                        <div class="text-gray-500 flex gap-2 mt-1">
                            <span><i class="ph ph-whatsapp-logo"></i> ${p.telefone}</span>
                            <span><i class="ph ph-identification-card"></i> ${p.cpf || '-'}</span>
                        </div>
                        ${p.acompanhantes_qtd > 0 ? `
                            <div class="mt-1 pt-1 border-t border-gray-100 text-blue-800">
                                <span class="font-bold">+${p.acompanhantes_qtd} Acomp.</span>
                                <span class="block italic text-gray-500 truncate">${p.acompanhantes_info || ''}</span>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                div.innerHTML = "Nenhum inscrito ainda.";
            }
        }

        async function exportarExcel() {
             const { data } = await supabaseClient
                .from('participantes')
                .select('nome, cpf, telefone, email, acompanhantes_qtd, acompanhantes_info, data_cadastro, eventos(nome, data_evento)')
                .order('data_cadastro', { ascending: false });

            if (!data || !data.length) return alert("Sem dados.");

            let csv = "\uFEFFNome,CPF,Telefone,Email,Qtd Acomp.,Nomes Acomp.,Evento,Data Evento\n";

            data.forEach(r => {
                const dataEv = r.eventos?.data_evento ? new Date(r.eventos.data_evento).toLocaleDateString('pt-BR') : '';
                const nomeL = r.nome.replace(/,/g, ""); 
                const infoL = (r.acompanhantes_info || "").replace(/[\n\r,]/g, " "); // Limpa quebras de linha e virgulas
                
                csv += `${nomeL},${r.cpf},${r.telefone},${r.email},${r.acompanhantes_qtd},${infoL},${r.eventos?.nome},${dataEv}\n`;
            });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "inscritos_fortral.csv";
            link.click();
        }

        function copiarLink(texto) {
            navigator.clipboard.writeText(texto).then(() => alert("Link copiado!"));
        }
    </script>
</body>
</html>