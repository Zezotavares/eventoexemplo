<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convite Digital Fortral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .table-container { overflow-x: auto; }
        /* Animação suave para a capa */
        .fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex flex-col">

    <div class="bg-slate-900 p-4 text-center shadow-md relative z-0">
        <img src="https://www.fortral.com.br/wp-content/uploads/2025/06/logo.png" 
             alt="Logo Fortral" class="h-10 mx-auto object-contain mb-2">
    </div>

    <div class="max-w-4xl mx-auto mt-6 px-4 pb-10 w-full flex-grow relative">

        <div id="areaLogin" class="hidden max-w-sm mx-auto bg-white p-6 rounded-lg shadow-lg text-center mt-10 relative z-10">
            <div class="bg-blue-50 p-3 rounded text-blue-900 text-sm mb-4 flex items-center justify-center gap-2">
                <i class="ph ph-lock-key text-xl"></i> <span>Acesso Administrativo</span>
            </div>
            <div class="relative w-full mb-4">
                <input type="password" id="senhaAdmin" placeholder="Senha de acesso" 
                       class="w-full p-2 pr-10 border rounded text-center focus:border-blue-900 outline-none">
                <button type="button" onclick="toggleSenha()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-900">
                    <i class="ph ph-eye text-xl" id="iconeOlho"></i>
                </button>
            </div>
            <button onclick="verificarSenha()" class="w-full bg-slate-900 text-white p-2 rounded hover:bg-slate-800 font-bold">Entrar no Painel</button>
        </div>

        <div id="areaClienteContainer" class="hidden max-w-md mx-auto relative rounded-lg shadow-2xl overflow-hidden bg-white min-h-[500px]">
            
            <div id="introScreen" class="absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center text-center p-8 text-white">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-blue-900"></div>
                <div class="absolute bottom-0 left-0 w-full h-2 bg-gradient-to-r from-blue-900 to-blue-500"></div>

                <img src="https://www.fortral.com.br/wp-content/uploads/2025/06/logo.png" 
                     alt="Logo Fortral" class="h-12 mb-6 object-contain">
                
                <p class="text-blue-200 uppercase text-xs font-bold tracking-widest mb-2">Você foi convidado para</p>
                
                <h1 id="introTitulo" class="text-3xl font-bold mb-4 leading-tight">Carregando...</h1>
                
                <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 w-full mb-8 backdrop-blur-sm">
                    <div class="flex items-center justify-center gap-2 text-blue-300 mb-1">
                        <i class="ph ph-calendar text-xl"></i>
                        <span class="text-xs uppercase font-bold">Data do Evento</span>
                    </div>
                    <p id="introData" class="text-xl font-medium text-white">--/--/----</p>
                    <p id="introHora" class="text-sm text-gray-400">--:--</p>
                </div>

                <button onclick="abrirFormulario()" class="group relative w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg shadow-lg shadow-blue-900/50 transition-all transform hover:scale-[1.02]">
                    <span class="flex items-center justify-center gap-2 text-lg">
                        CONFIRMAR PRESENÇA <i class="ph ph-arrow-right font-bold group-hover:translate-x-1 transition"></i>
                    </span>
                    <div class="absolute inset-0 rounded-lg ring-2 ring-white/20 group-hover:ring-white/40 animate-pulse"></div>
                </button>
            </div>

            <div id="formularioReal" class="p-6 h-full flex flex-col">
                <div class="text-center mb-6 border-b pb-4">
                    <h2 class="text-xl font-bold text-slate-900" id="eventoNomeDisplay">Inscrição</h2>
                    <p class="text-gray-500 text-xs mt-1">Preencha seus dados abaixo</p>
                </div>

                <form id="formCadastro" class="space-y-4 flex-grow">
                    <input type="hidden" id="eventoIdInput">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase">Nome Completo</label>
                        <input type="text" id="clienteNome" required class="w-full p-2 border rounded mt-1 focus:border-blue-900 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    <div class="flex gap-2">
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-600 uppercase">CPF</label>
                            <input type="text" id="clienteCPF" maxlength="14" onkeyup="mascaraCPF(this)" required 
                                   placeholder="000.000.000-00" class="w-full p-2 border rounded mt-1 outline-none bg-gray-50 focus:bg-white transition">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-600 uppercase">WhatsApp</label>
                            <input type="tel" id="clienteTelefone" maxlength="15" onkeyup="mascaraTelefone(this)" required 
                                   placeholder="(00) 00000-0000" class="w-full p-2 border rounded mt-1 outline-none bg-gray-50 focus:bg-white transition">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase">E-mail</label>
                        <input type="email" id="clienteEmail" class="w-full p-2 border rounded mt-1 outline-none bg-gray-50 focus:bg-white transition">
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded border border-blue-100">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-blue-900">Vai levar acompanhantes?</label>
                            <input type="number" id="clienteQtdAcomp" min="0" value="0" class="w-16 p-1 border border-blue-200 rounded text-center text-blue-900 font-bold" onchange="toggleAreaAcompanhantes()">
                        </div>
                        <div id="areaDadosAcompanhantes" class="hidden">
                            <textarea id="clienteDadosAcomp" rows="2" class="w-full p-2 border rounded text-sm mt-2 focus:border-blue-900 outline-none" placeholder="Nome dos acompanhantes..."></textarea>
                        </div>
                    </div>

                    <button type="submit" id="btnSalvar" class="w-full bg-slate-900 text-white p-3 rounded hover:bg-slate-800 font-bold text-lg transition shadow-md mt-2">
                        Finalizar Inscrição
                    </button>
                </form>

                <div id="msgSucesso" class="hidden text-center py-10 h-full flex flex-col items-center justify-center animate-fade-in">
                    <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                        <i class="ph ph-check text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">Tudo Certo!</h2>
                    <p class="text-gray-600 mb-6 px-4">Sua inscrição foi confirmada na nossa lista.</p>
                    
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 w-full text-left relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1">Evento</p>
                        <p class="text-slate-900 font-bold text-lg leading-tight mb-2" id="sucessoTitulo"></p>
                        <p class="text-slate-600 text-sm flex items-center gap-1"><i class="ph ph-calendar"></i> <span id="sucessoDataMsg"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="areaAdmin" class="hidden bg-white rounded-lg shadow-xl overflow-hidden min-h-[500px]">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 p-1.5 rounded-full"><i class="ph ph-user-gear text-lg"></i></div>
                    <span class="font-bold">Painel Gerencial</span>
                </div>
                <button onclick="logout()" class="text-xs text-red-300 hover:text-white border border-red-900 hover:bg-red-900 px-3 py-1 rounded transition">Sair</button>
            </div>

            <div class="flex border-b">
                <button onclick="mudarAba('eventos')" id="tabEventos" class="flex-1 py-3 font-bold text-slate-600 border-b-2 border-transparent hover:bg-gray-50 bg-gray-100">
                    <i class="ph ph-calendar-plus"></i> Meus Eventos
                </button>
                <button onclick="mudarAba('participantes')" id="tabParticipantes" class="flex-1 py-3 font-bold text-blue-900 border-b-2 border-blue-900 bg-white">
                    <i class="ph ph-users-three"></i> Gerenciar Inscritos
                </button>
            </div>

            <div id="viewEventos" class="hidden p-6">
                <h3 class="font-bold text-lg text-slate-700 mb-4">Criar Novo Evento</h3>
                <div class="bg-gray-50 p-4 rounded border mb-6">
                    <div class="grid gap-3 md:grid-cols-3">
                        <input type="text" id="novoEventoNome" placeholder="Nome do Evento" class="md:col-span-2 w-full p-2 border rounded">
                        <input type="datetime-local" id="novoEventoData" class="w-full p-2 border rounded text-gray-600">
                    </div>
                    <button onclick="criarEvento()" class="mt-3 w-full bg-slate-900 text-white py-2 rounded font-bold hover:bg-slate-800">+ Criar Evento</button>
                </div>
                <h3 class="font-bold text-lg text-slate-700 mb-2">Links Ativos</h3>
                <ul id="listaEventosLinks" class="space-y-2 text-sm max-h-60 overflow-y-auto"></ul>
            </div>

            <div id="viewParticipantes" class="p-4 md:p-6">
                <div class="flex flex-col md:flex-row gap-3 mb-4 items-end">
                    <div class="w-full md:w-1/3">
                        <label class="text-xs font-bold text-gray-500 uppercase">Filtrar por Evento:</label>
                        <select id="filtroEvento" onchange="carregarParticipantesPainel()" class="w-full p-2 border border-blue-200 rounded bg-blue-50 font-medium text-blue-900">
                            <option value="">Todos os Eventos</option>
                        </select>
                    </div>
                    <div class="w-full md:w-1/3">
                        <label class="text-xs font-bold text-gray-500 uppercase">Buscar:</label>
                        <input type="text" id="buscaInput" onkeyup="filtrarTabela()" placeholder="Nome ou CPF..." class="w-full p-2 border rounded">
                    </div>
                    <div class="w-full md:w-1/3 flex gap-2">
                        <button onclick="exportarExcel()" class="flex-1 bg-green-600 text-white p-2 rounded hover:bg-green-700 font-bold text-sm flex items-center justify-center gap-1">
                            <i class="ph ph-microsoft-excel-logo text-lg"></i> Excel
                        </button>
                        <button onclick="carregarParticipantesPainel()" class="w-10 bg-gray-200 rounded flex items-center justify-center hover:bg-gray-300"><i class="ph ph-arrow-clockwise text-lg"></i></button>
                    </div>
                </div>
                <div class="flex gap-4 mb-4 text-sm">
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded font-bold">Titulares: <span id="countTitulares">0</span></div>
                    <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded font-bold">Acomp: <span id="countAcomp">0</span></div>
                    <div class="bg-gray-100 text-gray-800 px-3 py-1 rounded font-bold">Total: <span id="countTotal">0</span></div>
                </div>
                <div class="table-container border rounded-lg overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-700 font-bold uppercase text-xs">
                            <tr><th class="p-3">Nome / CPF</th><th class="p-3">Contato</th><th class="p-3">Evento</th><th class="p-3 text-center">Acomp.</th><th class="p-3 text-center">Ações</th></tr>
                        </thead>
                        <tbody id="tabelaParticipantes" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO ---
        const supabaseUrl = 'https://kixlaiwclsgbabtdfmtn.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpeGxhaXdjbHNnYmFidGRmbXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NjA4MzgsImV4cCI6MjA4MzEzNjgzOH0.r9OF9C88prJs4tuBkz6xu_lKjjzixz5UHnVKDbLtx2E';
        const SENHA_ADMIN = 'Fortral@1993';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- 2. CONTROLE DE TELA ---
        const areaLogin = document.getElementById('areaLogin');
        const areaClienteContainer = document.getElementById('areaClienteContainer');
        const areaAdmin = document.getElementById('areaAdmin');
        
        const urlParams = new URLSearchParams(window.location.search);
        const eventoIdParam = urlParams.get('evento_id');

        if (eventoIdParam) {
            iniciarModoCliente(eventoIdParam);
        } else {
            mostrarLogin();
        }

        // --- 3. MÁGICA DA ABERTURA ---
        function abrirFormulario() {
            // Adiciona classe de fade-out na capa
            const intro = document.getElementById('introScreen');
            intro.classList.add('fade-out');
            
            // Aguarda a animação e remove do DOM visualmente
            setTimeout(() => {
                intro.style.display = 'none';
            }, 800);
        }

        // --- 4. FUNÇÕES GERAIS ---
        function mostrarLogin() { areaLogin.classList.remove('hidden'); }
        function verificarSenha() {
            if (document.getElementById('senhaAdmin').value === SENHA_ADMIN) {
                areaLogin.classList.add('hidden');
                iniciarModoAdmin();
            } else alert("Senha incorreta!");
        }
        function toggleSenha() {
            const input = document.getElementById('senhaAdmin');
            const icon = document.getElementById('iconeOlho');
            input.type = input.type === "password" ? "text" : "password";
            icon.classList.toggle('ph-eye'); icon.classList.toggle('ph-eye-slash');
        }
        function logout() { location.reload(); }
        function formatarZap(t) { return t.replace(/\D/g, ""); }

        // --- 5. MÓDULO CLIENTE ---
        function mascaraTelefone(i) {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/^(\d\d)(\d)/g, "($1) $2"); v = v.replace(/(\d{5})(\d)/, "$1-$2"); i.value = v;
        }
        function mascaraCPF(i) {
            let v = i.value.replace(/\D/g, "");
            i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        }
        function toggleAreaAcompanhantes() {
            const qtd = document.getElementById('clienteQtdAcomp').value;
            const area = document.getElementById('areaDadosAcompanhantes');
            if(qtd > 0) area.classList.remove('hidden'); else area.classList.add('hidden');
        }

        async function iniciarModoCliente(id) {
            const { data, error } = await supabaseClient.from('eventos').select('*').eq('id', id).single();
            if (error || !data) {
                document.body.innerHTML = "<div class='text-center mt-10 p-4 font-bold text-slate-800'>Link inválido ou evento encerrado.</div>";
                return;
            }

            areaClienteContainer.classList.remove('hidden');
            
            // Preencher CAPA (Intro)
            document.getElementById('introTitulo').innerText = data.nome;
            if (data.data_evento) {
                const d = new Date(data.data_evento);
                document.getElementById('introData').innerText = d.toLocaleDateString('pt-BR');
                document.getElementById('introHora').innerText = d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) + "h";
            } else {
                document.getElementById('introData').innerText = "Data a definir";
            }

            // Preencher Formulário Interno
            document.getElementById('eventoNomeDisplay').innerText = data.nome;
            document.getElementById('eventoIdInput').value = id;
        }

        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSalvar');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Processando...'; btn.disabled = true;

            const dados = {
                evento_id: document.getElementById('eventoIdInput').value,
                nome: document.getElementById('clienteNome').value,
                cpf: document.getElementById('clienteCPF').value,
                telefone: document.getElementById('clienteTelefone').value,
                email: document.getElementById('clienteEmail').value,
                acompanhantes_qtd: document.getElementById('clienteQtdAcomp').value || 0,
                acompanhantes_info: document.getElementById('clienteDadosAcomp').value
            };

            const { data: existe } = await supabaseClient.from('participantes').select('id').eq('evento_id', dados.evento_id).eq('cpf', dados.cpf).maybeSingle();
            if (existe) {
                alert("Você já está inscrito neste evento!");
                btn.innerHTML = originalText; btn.disabled = false;
                return;
            }

            const { error } = await supabaseClient.from('participantes').insert([dados]);
            if (error) {
                alert("Erro: " + error.message);
                btn.innerHTML = originalText; btn.disabled = false;
            } else {
                // Sucesso
                document.getElementById('formCadastro').classList.add('hidden');
                document.getElementById('formularioReal').querySelector('.text-center').style.display = 'none'; // esconde cabeçalho form
                
                const sucessoDiv = document.getElementById('msgSucesso');
                sucessoDiv.classList.remove('hidden');
                
                // Preencher dados finais
                document.getElementById('sucessoTitulo').innerText = document.getElementById('introTitulo').innerText;
                document.getElementById('sucessoDataMsg').innerText = document.getElementById('introData').innerText + " às " + document.getElementById('introHora').innerText;
            }
        });

        // --- 6. MÓDULO ADMIN ---
        function iniciarModoAdmin() {
            areaAdmin.classList.remove('hidden');
            mudarAba('participantes');
            carregarEventosParaSelect();
            carregarEventosLinks();
            carregarParticipantesPainel();
        }

        function mudarAba(aba) {
            const ev = document.getElementById('viewEventos'); const part = document.getElementById('viewParticipantes');
            const tEv = document.getElementById('tabEventos'); const tPart = document.getElementById('tabParticipantes');
            
            if (aba === 'eventos') {
                ev.classList.remove('hidden'); part.classList.add('hidden');
                tEv.classList.add('border-blue-900', 'bg-white', 'text-blue-900'); tEv.classList.remove('border-transparent');
                tPart.classList.remove('border-blue-900', 'bg-white', 'text-blue-900'); tPart.classList.add('border-transparent');
            } else {
                ev.classList.add('hidden'); part.classList.remove('hidden');
                tPart.classList.add('border-blue-900', 'bg-white', 'text-blue-900'); tPart.classList.remove('border-transparent');
                tEv.classList.remove('border-blue-900', 'bg-white', 'text-blue-900'); tEv.classList.add('border-transparent');
            }
        }

        // Funções de dados Admin
        async function criarEvento() {
            const nome = document.getElementById('novoEventoNome').value;
            const dataLocal = document.getElementById('novoEventoData').value;
            
            if(!nome || !dataLocal) return alert("Preencha campos.");
            
            // CORREÇÃO DE FUSO HORÁRIO AQUI:
            // Convertemos a data local (ex: 10:00) para ISO UTC antes de enviar.
            const dataISO = new Date(dataLocal).toISOString();

            const { error } = await supabaseClient.from('eventos').insert([{ nome, data_evento: dataISO }]);
            if(error) alert(error.message); else { document.getElementById('novoEventoNome').value=""; document.getElementById('novoEventoData').value=""; carregarEventosLinks(); carregarEventosParaSelect(); alert("Criado!"); }
        }

        async function carregarEventosLinks() {
            const { data } = await supabaseClient.from('eventos').select('*').order('data_criacao', {ascending: false});
            const ul = document.getElementById('listaEventosLinks'); ul.innerHTML = "";
            if(data) data.forEach(ev => {
                const link = window.location.origin + window.location.pathname + "?evento_id=" + ev.id;
                // Ajuste de exibição
                const dataFormatada = ev.data_evento ? new Date(ev.data_evento).toLocaleDateString('pt-BR') : 'S/ data';
                ul.innerHTML += `<li class="bg-white border p-2 flex justify-between items-center text-xs"><span><strong>${ev.nome}</strong> (${dataFormatada})</span><button onclick="navigator.clipboard.writeText('${link}').then(()=>alert('Copiado'))" class="bg-blue-100 text-blue-900 px-2 rounded">Link</button></li>`;
            });
        }

        async function carregarEventosParaSelect() {
            const { data } = await supabaseClient.from('eventos').select('id, nome').order('data_criacao', {ascending: false});
            const sel = document.getElementById('filtroEvento'); sel.innerHTML = '<option value="">Todos</option>';
            if(data) data.forEach(ev => sel.innerHTML += `<option value="${ev.id}">${ev.nome}</option>`);
        }

        async function carregarParticipantesPainel() {
            const tb = document.getElementById('tabelaParticipantes'); tb.innerHTML = '<tr><td colspan="5" class="p-4 text-center"><i class="ph ph-spinner animate-spin"></i></td></tr>';
            let q = supabaseClient.from('participantes').select('id, nome, cpf, telefone, email, acompanhantes_qtd, acompanhantes_info, eventos(nome)').order('data_cadastro', {ascending:false});
            const evId = document.getElementById('filtroEvento').value;
            if(evId) q = q.eq('evento_id', evId);
            const { data } = await q;

            if(!data || !data.length) { tb.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Sem registros.</td></tr>'; atualizarContadores([]); return; }
            
            atualizarContadores(data);
            tb.innerHTML = "";
            data.forEach(p => {
                const zap = `https://wa.me/55${formatarZap(p.telefone)}`;
                const acomp = p.acompanhantes_qtd > 0 ? `<div class="tooltip-container relative group cursor-help"><span class="bg-purple-100 text-purple-800 font-bold px-2 py-1 rounded-full text-xs">+${p.acompanhantes_qtd}</span><div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-48 bg-slate-800 text-white text-xs p-2 rounded z-20 shadow-lg">${p.acompanhantes_info}</div></div>` : '<span class="text-gray-300">-</span>';
                tb.innerHTML += `<tr class="bg-white border-b hover:bg-blue-50"><td class="p-3"><div class="font-bold text-slate-800">${p.nome}</div><div class="text-xs text-gray-500 font-mono">${p.cpf || '-'}</div></td><td class="p-3"><a href="${zap}" target="_blank" class="text-green-600 font-bold hover:underline flex gap-1"><i class="ph ph-whatsapp-logo"></i> ${p.telefone}</a></td><td class="p-3"><span class="bg-gray-100 px-2 py-1 rounded text-xs border">${p.eventos?.nome}</span></td><td class="p-3 text-center">${acomp}</td><td class="p-3 text-center"><button onclick="deletarParticipante(${p.id})" class="text-red-400 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></td></tr>`;
            });
        }
        
        function filtrarTabela() {
            const termo = document.getElementById('buscaInput').value.toLowerCase();
            document.querySelectorAll('#tabelaParticipantes tr').forEach(tr => {
                tr.style.display = tr.innerText.toLowerCase().includes(termo) ? '' : 'none';
            });
        }

        function atualizarContadores(d) {
            const t = d.length; const a = d.reduce((s, c) => s + (c.acompanhantes_qtd||0), 0);
            document.getElementById('countTitulares').innerText=t; document.getElementById('countAcomp').innerText=a; document.getElementById('countTotal').innerText=t+a;
        }

        async function deletarParticipante(id) {
            if(!confirm("Excluir cadastro?")) return;
            if(prompt("Senha Admin:") !== SENHA_ADMIN) return alert("Senha errada.");
            await supabaseClient.from('participantes').delete().eq('id', id);
            carregarParticipantesPainel();
        }

        async function exportarExcel() {
            let q = supabaseClient.from('participantes').select('nome, cpf, telefone, email, acompanhantes_qtd, acompanhantes_info, eventos(nome, data_evento)').order('data_cadastro');
            const evId = document.getElementById('filtroEvento').value; if(evId) q = q.eq('evento_id', evId);
            const { data } = await q;
            if(!data || !data.length) return alert("Sem dados.");
            let csv = "\uFEFFNome;CPF;Telefone;Email;Qtd Acomp;Nomes Acomp;Evento;Data\n";
            data.forEach(r => {
                const esc = t => '"' + String(t||"").replace(/"/g, '""') + '"';
                const dt = r.eventos?.data_evento ? new Date(r.eventos.data_evento).toLocaleDateString() : "";
                csv += `${esc(r.nome)};${esc(r.cpf)};${esc(r.telefone)};${esc(r.email)};${r.acompanhantes_qtd};${esc(r.acompanhantes_info)};${esc(r.eventos?.nome)};${dt}\n`;
            });
            const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'})); a.download = `Relatorio_${new Date().toISOString().slice(0,10)}.csv`; a.click();
        }
    </script>
</body>
</html>